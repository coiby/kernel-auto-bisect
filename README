# Automated Kernel Kdump Bisection

This set of scripts and services automates the process of using `git bisect` to find a commit that introduced a kdump-related issue in the Linux kernel. It is designed to handle the required reboots between testing each commit.

## How It Works

The process is managed by a master script (`bisect-kernel.sh`) which is launched on every boot by a systemd service (`kdump-bisect.service`). The script uses state files in `/var/local/kdump-bisect` to track its current phase:

1.  **BUILD**: On the original "good" kernel, the script checks out a commit, builds it, installs it, and sets it as the default for the next boot. It then reboots.
2.  **TEST**: The system boots into the newly compiled "test" kernel. The script runs your custom `reproducer.sh` to check for the kdump issue. It records the result ("good" or "bad") and sets the boot device back to the original kernel. It then reboots again.
3.  **CONTINUE**: The system is now back on the original kernel. The script reads the result, runs the appropriate `git bisect good` or `git bisect bad` command, and then starts the next **BUILD** cycle.

This loop continues until `git bisect` identifies the first bad commit.

## Prerequisites

- A RHEL-based system (e.g., Fedora, CentOS, RHEL) that uses `grubby` for managing boot entries.
- A dedicated machine or VM for the bisection, as it will reboot frequently.
- A local clone of the Linux kernel source code.
- All necessary development tools for building the kernel (`gcc`, `make`, `flex`, `bison`, `openssl-devel`, etc.).
- `kdump` must be configured and working on a known-good kernel.

## Setup Instructions

1.  **Create Directory:**
    ```bash
    sudo mkdir -p /usr/local/bin/kdump-bisect
    ```

2.  **Copy Scripts:**
    - Place `bisect-kernel.sh` into `/usr/local/bin/kdump-bisect/`.
    - Make it executable: `sudo chmod +x /usr/local/bin/kdump-bisect/bisect-kernel.sh`.

3.  **Configure `bisect.conf`:**
    - Copy the `bisect.conf` file to `/usr/local/bin/kdump-bisect/bisect.conf`.
    - **Edit this file carefully**:
        - `KERNEL_SRC_DIR`: Set the absolute path to your kernel source tree.
        - `GOOD_COMMIT` / `BAD_COMMIT`: Provide the commit hashes to start the bisection.
        - `REPRODUCER_SCRIPT`: Set the absolute path to your custom reproducer script.
        - `RUNS_PER_COMMIT`: Adjust if your issue is intermittent.
        - `MAKE_JOBS`: Set to your number of CPU cores to speed up builds.

4.  **Create Your `reproducer.sh`:**
    - Use the provided template to create your own test script.
    - Place it at the location you specified in `bisect.conf`.
    - Make it executable: `sudo chmod +x /path/to/your/reproducer.sh`.
    - **Test your reproducer manually** on a known-good and known-bad kernel to ensure it returns the correct exit codes.

5.  **Install the Systemd Service:**
    - Copy `kdump-bisect.service` to `/etc/systemd/system/`.
    - Reload the systemd daemon: `sudo systemctl daemon-reload`.

## Running the Bisection

1.  **Enable the Service:**
    Before you start, you must enable the service so it persists across reboots.
    ```bash
    sudo systemctl enable kdump-bisect.service
    ```

2.  **Start the Process:**
    Manually run the `start` command. This will kick off the entire automated process.
    ```bash
    sudo /usr/local/bin/kdump-bisect/bisect-kernel.sh start
    ```

The machine will now reboot and begin the first build cycle.

## Monitoring and Stopping

- **Monitoring:** You can watch the progress by tailing the log file:
  ```bash
  tail -f /var/local/kdump-bisect/bisect.log
  ```

- **Stopping:** To abort the bisection process, you must disable the service and reset the git state.
  1.  Wait for the machine to boot back into your **original** kernel (not a `kdump-bisect` kernel).
  2.  Disable the service:
      ```bash
      sudo systemctl disable kdump-bisect.service
      ```
  3.  Clean up the git repository:
      ```bash
      cd /path/to/your/linux/source
      sudo git bisect reset
      ```
  4.  (Optional) Remove the state directory:
      ```bash
      sudo rm -rf /var/local/kdump-bisect
      ```
